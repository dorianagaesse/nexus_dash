name: Deploy Vercel (CD + Rollback)

on:
  workflow_run:
    workflows: ["Quality Gates"]
    branches:
      - main
    types:
      - completed
  workflow_dispatch:
    inputs:
      action:
        description: "Operation to execute"
        required: true
        type: choice
        options:
          - deploy-preview
          - deploy-production-staged
          - promote
          - rollback
      deployment_id_or_url:
        description: "Required for promote/rollback actions"
        required: false
        type: string
      git_ref:
        description: "Git ref for deploy actions (branch/tag/SHA)"
        required: false
        default: "main"
        type: string

permissions:
  contents: read

concurrency:
  group: vercel-cd-${{ github.workflow }}-${{ github.event.workflow_run.head_branch || github.ref }}
  cancel-in-progress: false

jobs:
  auto-production-staged:
    name: Auto Deploy Production (staged)
    if: >
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_CLI_VERSION: 50.18.0
      VERCEL_SCOPE: ${{ secrets.VERCEL_ORG_ID }}

    steps:
      - name: Validate required Vercel secrets
        run: |
          missing=0
          for key in VERCEL_TOKEN VERCEL_ORG_ID VERCEL_PROJECT_ID; do
            if [ -z "${!key}" ]; then
              echo "::error::Missing required GitHub secret: $key"
              missing=1
            fi
          done
          if [ "$missing" -eq 1 ]; then
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Pull Vercel environment (production)
        run: npx vercel@${VERCEL_CLI_VERSION} pull --yes --environment=production --scope="$VERCEL_SCOPE" --token="$VERCEL_TOKEN"

      - name: Build prebuilt artifact (production)
        run: npx vercel@${VERCEL_CLI_VERSION} build --prod --scope="$VERCEL_SCOPE" --token="$VERCEL_TOKEN"

      - name: Deploy staged production build
        id: deploy_staged
        run: |
          deployment_url=$(npx vercel@${VERCEL_CLI_VERSION} deploy --prebuilt --prod --skip-domain --scope="$VERCEL_SCOPE" --token="$VERCEL_TOKEN")
          echo "deployment_url=$deployment_url" >> "$GITHUB_OUTPUT"
          echo "$deployment_url" > staged-production-deployment.txt

      - name: Upload staged deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: auto-staged-production-deployment
          path: staged-production-deployment.txt
          if-no-files-found: error

      - name: Job summary
        run: |
          echo "## Staged production deployment created" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- URL: \`${{ steps.deploy_staged.outputs.deployment_url }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Next step: run workflow dispatch with \`action=promote\` to promote this deployment." >> "$GITHUB_STEP_SUMMARY"

  manual-operation:
    name: Manual Deploy/Promote/Rollback
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_CLI_VERSION: 50.18.0
      VERCEL_SCOPE: ${{ secrets.VERCEL_ORG_ID }}

    steps:
      - name: Validate required Vercel secrets
        run: |
          missing=0
          for key in VERCEL_TOKEN VERCEL_ORG_ID VERCEL_PROJECT_ID; do
            if [ -z "${!key}" ]; then
              echo "::error::Missing required GitHub secret: $key"
              missing=1
            fi
          done
          if [ "$missing" -eq 1 ]; then
            exit 1
          fi

      - name: Checkout
        if: ${{ inputs.action == 'deploy-preview' || inputs.action == 'deploy-production-staged' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref }}

      - name: Setup Node.js
        if: ${{ inputs.action == 'deploy-preview' || inputs.action == 'deploy-production-staged' }}
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        if: ${{ inputs.action == 'deploy-preview' || inputs.action == 'deploy-production-staged' }}
        run: npm ci

      - name: Generate Prisma client
        if: ${{ inputs.action == 'deploy-preview' || inputs.action == 'deploy-production-staged' }}
        run: npx prisma generate

      - name: Deploy preview
        if: inputs.action == 'deploy-preview'
        id: deploy_preview
        run: |
          npx vercel@${VERCEL_CLI_VERSION} pull --yes --environment=preview --scope="$VERCEL_SCOPE" --token="$VERCEL_TOKEN"
          npx vercel@${VERCEL_CLI_VERSION} build --scope="$VERCEL_SCOPE" --token="$VERCEL_TOKEN"
          deployment_url=$(npx vercel@${VERCEL_CLI_VERSION} deploy --prebuilt --scope="$VERCEL_SCOPE" --token="$VERCEL_TOKEN")
          echo "deployment_url=$deployment_url" >> "$GITHUB_OUTPUT"
          echo "$deployment_url" > preview-deployment.txt

      - name: Deploy production (staged)
        if: inputs.action == 'deploy-production-staged'
        id: deploy_prod_staged
        run: |
          npx vercel@${VERCEL_CLI_VERSION} pull --yes --environment=production --scope="$VERCEL_SCOPE" --token="$VERCEL_TOKEN"
          npx vercel@${VERCEL_CLI_VERSION} build --prod --scope="$VERCEL_SCOPE" --token="$VERCEL_TOKEN"
          deployment_url=$(npx vercel@${VERCEL_CLI_VERSION} deploy --prebuilt --prod --skip-domain --scope="$VERCEL_SCOPE" --token="$VERCEL_TOKEN")
          echo "deployment_url=$deployment_url" >> "$GITHUB_OUTPUT"
          echo "$deployment_url" > staged-production-deployment.txt

      - name: Validate deployment target exists
        if: inputs.action == 'promote' || inputs.action == 'rollback'
        run: |
          if [ -z "${{ inputs.deployment_id_or_url }}" ]; then
            echo "::error::deployment_id_or_url is required for promote/rollback."
            echo "::error::Use a deployment URL/ID from workflow artifacts or the Vercel dashboard."
            exit 1
          fi

          if ! npx vercel@${VERCEL_CLI_VERSION} inspect "${{ inputs.deployment_id_or_url }}" --scope="$VERCEL_SCOPE" --token="$VERCEL_TOKEN" > /tmp/vercel-inspect.txt 2>&1; then
            echo "::error::Deployment '${{ inputs.deployment_id_or_url }}' could not be validated for this project."
            echo "::error::Use a valid deployment URL/ID from previous workflow artifacts or from the Vercel dashboard."
            cat /tmp/vercel-inspect.txt
            exit 1
          fi

      - name: Promote deployment to production
        if: inputs.action == 'promote'
        run: |
          npx vercel@${VERCEL_CLI_VERSION} promote "${{ inputs.deployment_id_or_url }}" --scope="$VERCEL_SCOPE" --token="$VERCEL_TOKEN"

      - name: Rollback production deployment
        if: inputs.action == 'rollback'
        run: |
          npx vercel@${VERCEL_CLI_VERSION} rollback "${{ inputs.deployment_id_or_url }}" --scope="$VERCEL_SCOPE" --token="$VERCEL_TOKEN"

      - name: Upload preview deployment artifact
        if: inputs.action == 'deploy-preview'
        uses: actions/upload-artifact@v4
        with:
          name: preview-deployment
          path: preview-deployment.txt
          if-no-files-found: error

      - name: Upload staged production deployment artifact
        if: inputs.action == 'deploy-production-staged'
        uses: actions/upload-artifact@v4
        with:
          name: manual-staged-production-deployment
          path: staged-production-deployment.txt
          if-no-files-found: error

      - name: Job summary
        if: always()
        run: |
          echo "## Manual Vercel operation" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Action: \`${{ inputs.action }}\`" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ inputs.action }}" = "deploy-preview" ]; then
            if [ -n "${{ steps.deploy_preview.outputs.deployment_url }}" ]; then
              echo "- Preview URL: \`${{ steps.deploy_preview.outputs.deployment_url }}\`" >> "$GITHUB_STEP_SUMMARY"
            fi
          fi
          if [ "${{ inputs.action }}" = "deploy-production-staged" ]; then
            if [ -n "${{ steps.deploy_prod_staged.outputs.deployment_url }}" ]; then
              echo "- Staged production URL: \`${{ steps.deploy_prod_staged.outputs.deployment_url }}\`" >> "$GITHUB_STEP_SUMMARY"
            fi
            echo "- Next step: run with \`action=promote\`." >> "$GITHUB_STEP_SUMMARY"
          fi
          if [ "${{ inputs.action }}" = "promote" ] || [ "${{ inputs.action }}" = "rollback" ]; then
            echo "- Deployment target: \`${{ inputs.deployment_id_or_url }}\`" >> "$GITHUB_STEP_SUMMARY"
          fi
